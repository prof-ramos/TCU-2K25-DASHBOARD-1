name: Dependency Updates

on:
  schedule:
    # Executa toda segunda-feira Ã s 9h
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  update-dependencies:
    name: ğŸ“¦ Atualizar DependÃªncias
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: ğŸ“¦ Verificar atualizaÃ§Ãµes disponÃ­veis
        run: |
          npm outdated > outdated.txt || true
          if [ -s outdated.txt ]; then
            echo "## ğŸ“¦ DependÃªncias Desatualizadas" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat outdated.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Todas as dependÃªncias estÃ£o atualizadas!" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ” Audit de SeguranÃ§a
        run: |
          npm audit --json > audit.json || true
          echo "## ğŸ” Audit de SeguranÃ§a" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
          cat audit.json | jq '.metadata' >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ“ Criar Issue se houver vulnerabilidades
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const audit = JSON.parse(fs.readFileSync('audit.json', 'utf8'));

            if (audit.metadata.vulnerabilities.high > 0 || audit.metadata.vulnerabilities.critical > 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ğŸš¨ Vulnerabilidades de SeguranÃ§a Detectadas',
                body: `## Vulnerabilidades Encontradas\n\n` +
                      `- **Critical**: ${audit.metadata.vulnerabilities.critical}\n` +
                      `- **High**: ${audit.metadata.vulnerabilities.high}\n` +
                      `- **Moderate**: ${audit.metadata.vulnerabilities.moderate}\n` +
                      `- **Low**: ${audit.metadata.vulnerabilities.low}\n\n` +
                      `Execute \`npm audit fix\` para tentar corrigir automaticamente.`,
                labels: ['security', 'dependencies']
              });
            }
